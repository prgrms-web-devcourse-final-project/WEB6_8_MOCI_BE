name: Deploy to EC2

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v4
    
    # 2. JDK 21 ì„¤ì •
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'
    
    # 3. Gradle ë¹Œë“œ ê¶Œí•œ ë¶€ì—¬
    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew
    
    # 4. ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
    - name: Build with Gradle
      run: ./gradlew clean build -x test
    
    # 5. JAR íŒŒì¼ëª… í™•ì¸ (plain.jar ì œì™¸)
    - name: Get JAR filename
      id: jar
      run: |
        JAR_FILE=$(ls build/libs/*.jar | grep -v plain | head -n 1)
        echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
        echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT
        echo "Found JAR: $(basename $JAR_FILE)"
    
    # 6. SSH í‚¤ ì„¤ì • (Base64 ë””ì½”ë”©)
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" | base64 -d > ~/.ssh/deploy_key.pem
        chmod 600 ~/.ssh/deploy_key.pem
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
    
    # 7. ê¸°ì¡´ ë°±ì—… ìƒì„± (ë¡¤ë°±ìš©)
    - name: Backup previous JAR on EC2
      run: |
        ssh -i ~/.ssh/deploy_key.pem ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
          if [ -f ~/app.jar ]; then
            cp ~/app.jar ~/app.jar.backup
            echo "âœ… Previous JAR backed up"
          fi
        ENDSSH
    
    # 8. ìƒˆ JAR íŒŒì¼ ì „ì†¡
    - name: Copy JAR to EC2
      run: |
        scp -i ~/.ssh/deploy_key.pem \
          ${{ steps.jar.outputs.jar_file }} \
          ubuntu@${{ secrets.EC2_HOST }}:~/app.jar
        echo "âœ… JAR file uploaded: ${{ steps.jar.outputs.jar_name }}"
    
    # 9. ë°°í¬ ì‹¤í–‰
    - name: Deploy on EC2
      run: |
        ssh -i ~/.ssh/deploy_key.pem ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
          echo "ğŸ”„ Starting deployment..."
          
          # ê¸°ì¡´ Java í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          if pgrep -f 'java -jar' > /dev/null; then
            echo "Stopping existing Java process..."
            pkill -f 'java -jar' || true
            sleep 3
          fi
          
          # í”„ë¡œì„¸ìŠ¤ê°€ ì™„ì „íˆ ì¢…ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
          if pgrep -f 'java -jar' > /dev/null; then
            echo "Force killing Java process..."
            pkill -9 -f 'java -jar' || true
            sleep 2
          fi
          
          # ìƒˆ JAR ì‹¤í–‰ (ëª…ë ¹ì¤„ ì¸ì ë°©ì‹ - íŠ¹ìˆ˜ë¬¸ì ì•ˆì „!)
          nohup java -jar ~/app.jar \
            --spring.profiles.active=prod \
            --spring.datasource.url=jdbc:mysql://${{ secrets.DB_HOST }}:3306/${{ secrets.DB_NAME }} \
            --spring.datasource.username=${{ secrets.DB_USERNAME }} \
            --spring.datasource.password='${{ secrets.DB_PASSWORD }}' \
            --spring.jpa.hibernate.ddl-auto=update \
            --cloud.aws.s3.bucket=${{ secrets.S3_BUCKET_NAME }} \
            --cloud.aws.region.static=${{ secrets.AWS_REGION }} \
            --file.storage.type=s3 \
            --custom.jwt.secretKey=${{ secrets.JWT_SECRET_KEY }} \
            --gemini.api.key=${{ secrets.GEMINI_API_KEY }} \
            --gemini.api.url=${{ secrets.GEMINI_API_URL }} \
            --spring.security.oauth2.client.registration.kakao.client-id=${{ secrets.KAKAO_CLIENT_ID }} \
            --custom.site.cookieDomain=${{ secrets.COOKIE_DOMAIN }} \
            --custom.site.frontUrl=${{ secrets.FRONT_URL }} \
            --custom.site.backUrl=${{ secrets.BACK_URL }} \
            > ~/app.log 2>&1 &
          
          echo "â³ Waiting for application to start..."
          sleep 5
          
          # í”„ë¡œì„¸ìŠ¤ ì‹œì‘ í™•ì¸
          if pgrep -f 'java -jar' > /dev/null; then
            PID=$(pgrep -f 'java -jar')
            echo "âœ… Application started successfully!"
            echo "Process ID: $PID"
          else
            echo "âŒ Application failed to start!"
            echo "Last 100 lines of log:"
            tail -100 ~/app.log
            exit 1
          fi
        ENDSSH
    
    # 10. Health Check
    - name: Health Check
      run: |
        echo "â³ Waiting for application to be ready..."
        sleep 15
        
        for i in {1..10}; do
          echo "Health check attempt $i/10..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}:8080/actuator/health || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "âœ… Health check passed! Application is healthy."
            exit 0
          fi
          
          echo "â³ Status: $response, retrying in 5 seconds..."
          sleep 5
        done
        
        echo "âŒ Health check failed after 10 attempts"
        echo "Checking application logs..."
        ssh -i ~/.ssh/deploy_key.pem ubuntu@${{ secrets.EC2_HOST }} "tail -100 ~/app.log"
        exit 1
    
    # 11. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    - name: Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ =================================="
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸ‰ =================================="
        echo "Application URL: http://${{ secrets.EC2_HOST }}:8080"
        echo "Time: $(date)"
