<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>WebRTC Signaling Test</title>
</head>
<body>
<h3>WebRTC 화면공유 테스트</h3>
<button id="shareBtn">화면 공유 시작</button>
<div>
    <video id="localVideo" autoplay muted style="width:300px; border:1px solid #ccc;"></video>
    <video id="remoteVideo" autoplay style="width:300px; border:1px solid #ccc;"></video>
</div>

<script src="/webjars/sockjs-client/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/stomp.min.js"></script>
<script>
    const socket = new SockJS('/api/v1/ws');
    const stomp = Stomp.over(socket);
    const iceConfig = { iceServers:[{ urls:'stun:stun.l.google.com:19302' }] };
    let pc;

    // stomp.connect(
    //   { Authorization: 'Bearer ' + localStorage.getItem('ACCESS_TOKEN') },
    //   () => {
    //     stomp.subscribe('/api/v1/chat/topic/webrtc', frame => onSignal(JSON.parse(frame.body)));
    //   },
    //   err => console.error('STOMP connect error', err)
    // );
    const stompClient = Stomp.over(socket);

    stompClient.connect(
        { Authorization: "Bearer " + localStorage.getItem("accessToken") }, // ✅ 헤더 추가
        (frame) => {
            console.log("✅ Connected: " + frame);
        },
        (error) => {
            console.error("❌ STOMP connect error", error);
        }
    );

    document.getElementById('shareBtn').onclick = async () => {
      const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
      document.getElementById('localVideo').srcObject = stream;
      startPeer(stream, true);
    };

    function startPeer(stream, isOfferer) {
        pc = new RTCPeerConnection(iceConfig);
        if (stream) stream.getTracks().forEach(t=>pc.addTrack(t, stream));
        pc.onicecandidate = e => e.candidate && send({type:'candidate', candidate:JSON.stringify(e.candidate)});
        pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
        if (isOfferer) createOffer();
    }

    async function createOffer() {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        send({type:'offer', sdp:offer.sdp});
    }

    async function onSignal(msg) {
        if (!pc && msg.type!=='offer') return;
        if (msg.type==='offer') {
            startPeer(null,false);
            await pc.setRemoteDescription(new RTCSessionDescription(msg));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            send({type:'answer', sdp:answer.sdp});

        } else if (msg.type==='answer') {
            await pc.setRemoteDescription(new RTCSessionDescription(msg));

        } else if (msg.type==='candidate') {
            await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(msg.candidate)));
        }
    }

    function send(payload) {
      stomp.send('/api/v1/chat/app/webrtc', {}, JSON.stringify(payload));
    }
</script>
</body>
</html>